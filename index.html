<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>VSPhone Cloud Dashboard</title>
    <style>
        :root { --primary: #5865f2; --success: #3ba55d; --bg: #f3f4f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #edf2f7; text-align: left; }
        th { background: #f8fafc; color: #64748b; font-size: 11px; text-transform: uppercase; }
        .btn { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; font-size: 11px; transition: 0.2s; }
        .btn-login { background: var(--primary); }
        .btn-buff { background: var(--success); }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .invite-link { font-family: monospace; font-size: 11px; color: #2ecc71; font-weight: bold; }
        #sync-status { font-size: 12px; font-weight: bold; padding: 5px 12px; border-radius: 20px; background: #dfe6e9; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>üöÄ VSPhone Cloud Manager</h2>
        <div id="sync-status">ƒêang k·∫øt n·ªëi Cloud...</div>
    </header>

    <table id="accountTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Platform</th>
                <th>Email (C·ªôt B)</th>
                <th>Password (C·ªôt C)</th>
                <th>M√£ m·ªùi (C·ªôt D)</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="tbody">
            <tr><td colspan="6" style="text-align:center; padding:30px;">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheets...</td></tr>
        </tbody>
    </table>
</div>

<script>
// LINK WEB APP B·∫†N V·ª™A CUNG C·∫§P
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxvECDp69CvpEWLrFBG1mqjxoskNjOYPZAu4Dp961JpY_lDwhp0_qiQBoX4i2WjuIO1/exec'; 
// LINK ƒê·ªåC D·ªÆ LI·ªÜU T·ª™ SHEET
const SHEET_JSON_URL = 'https://opensheet.elk.sh/1fU4ppbOWDikPkEWUdXiyqrUn8JHXvt-PJjS778J-R8M/Trang%20t%C3%ADnh1';

let currentEmail = null;
let currentIndex = null;

// L·∫ÆNG NGHE M√É M·ªúI T·ª™ USERSCRIPT V√Ä GHI L√äN SHEET
setInterval(async () => {
    const collectedLink = localStorage.getItem('VS_LAST_COLLECTED_LINK');
    
    if (collectedLink && currentEmail) {
        const statusBox = document.getElementById('sync-status');
        const cell = document.getElementById(`invite-res-${currentIndex}`);
        
        statusBox.innerText = "üîÑ ƒêang ƒë·ªìng b·ªô Sheet cho " + currentEmail + "...";
        statusBox.style.color = "#d35400";
        cell.innerText = "‚è≥ ƒêang ghi Sheet...";

        try {
            // Th·ª±c hi·ªán ghi d·ªØ li·ªáu l√™n Google Sheets
            await fetch(`${WEB_APP_URL}?email=${encodeURIComponent(currentEmail)}&code=${encodeURIComponent(collectedLink)}`, { mode: 'no-cors' });
            
            // C·∫≠p nh·∫≠t giao di·ªán sau khi ghi th√†nh c√¥ng
            cell.innerText = collectedLink;
            statusBox.innerText = "‚úÖ ƒê√£ l∆∞u v√†o C·ªôt D th√†nh c√¥ng!";
            statusBox.style.color = "green";
        } catch (e) {
            statusBox.innerText = "‚ùå L·ªói k·∫øt n·ªëi khi ghi Sheet!";
            statusBox.style.color = "red";
            cell.innerText = "‚ùå L·ªói l∆∞u";
        }
        
        // X√≥a m√£ t·∫°m ƒë·ªÉ tr√°nh l·∫∑p
        localStorage.removeItem('VS_LAST_COLLECTED_LINK');
        currentEmail = null;
        currentIndex = null;
    }
}, 1000);

// T·∫¢I DANH S√ÅCH T·ª™ SHEET
async function loadData() {
    try {
        const res = await fetch(SHEET_JSON_URL);
        const data = await res.json();
        const tbody = document.querySelector('#tbody');
        tbody.innerHTML = '';

        data.forEach((row, i) => {
            if(!row.email) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${i + 1}</td>
                <td>${row.platform || 'VSPhone'}</td>
                <td><strong>${row.email}</strong></td>
                <td style="font-family:monospace">${row.password}</td>
                <td class="invite-link" id="invite-res-${i}">${row.invite || 'Ch·ªù nh·∫∑t m√£...'}</td>
                <td>
                    <button class="btn btn-login" onclick="login('${row.email}','${row.password}', ${i})">LOGIN</button>
                    <button class="btn btn-buff" onclick="buff('${row.invite}', ${i})">BUFF</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('sync-status').innerText = "Cloud Online (" + data.length + " acc)";
    } catch (e) {
        document.getElementById('sync-status').innerText = "‚ùå L·ªói t·∫£i d·ªØ li·ªáu!";
    }
}

function login(email, pass, index) {
    currentIndex = index;
    currentEmail = email;
    const win = window.open('https://cloud.vsphone.com/login', '_blank');
    
    setTimeout(() => {
        win.postMessage({ type: 'AUTO_LOGIN', email, password: pass }, 'https://cloud.vsphone.com');
        setTimeout(() => { 
            win.location.href = "https://cloud.vsphone.com/share/invite"; 
        }, 3000);
    }, 2000);
}

function buff(inviteCode, index) {
    // N·∫øu ch∆∞a c√≥ m√£ tr√™n Sheet th√¨ l·∫•y m√£ t·ª´ √¥ hi·ªÉn th·ªã t·∫°m
    const invite = inviteCode && inviteCode !== '...' ? inviteCode : document.getElementById(`invite-res-${index}`).innerText;
    
    if (invite.includes("Ch·ªù") || !invite) {
        return alert("Vui l√≤ng nh·∫∑t m√£ (Login) tr∆∞·ªõc khi Buff!");
    }
    
    const channelId = prompt("Nh·∫≠p ID k√™nh Discord:");
    if (channelId) {
        window.open(`https://discord.com/channels/@me/${channelId}?buff=true`, '_blank');
    }
}

loadData();
</script>
</body>
</html>
