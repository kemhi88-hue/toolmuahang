<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>VSPhone Dashboard - C·∫≠p nh·∫≠t C·ªôt D</title>
    <style>
        :root { --primary: #5865f2; --success: #3ba55d; --bg: #f3f4f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; border-bottom: 1px solid #edf2f7; text-align: left; }
        th { background: #f8fafc; color: #64748b; font-size: 11px; text-transform: uppercase; }
        .btn { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; font-size: 11px; transition: 0.2s; }
        .btn-login { background: var(--primary); }
        .btn-buff { background: var(--success); }
        .btn:hover { opacity: 0.8; transform: translateY(-1px); }
        .invite-link { font-family: monospace; font-size: 11px; color: #2ecc71; font-weight: bold; }
        #sync-status { font-size: 12px; padding: 5px 12px; border-radius: 20px; background: #e2e8f0; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h2>VSPhone Management</h2>
        <div id="sync-status">Tr·∫°ng th√°i: ƒêang k·∫øt n·ªëi...</div>
    </header>

    <table id="accountTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Platform (A)</th>
                <th>Email (B)</th>
                <th>Password (C)</th>
                <th>M√£ m·ªùi (D)</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody id="tbody">
            <tr><td colspan="6" style="text-align:center; padding:30px;">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
        </tbody>
    </table>
</div>

<script>
// QUAN TR·ªåNG: Thay link Web App c·ªßa b·∫°n v√†o ƒë√¢y
const WEB_APP_URL = 'D√ÅN_LINK_WEB_APP_SCRIPT_C·ª¶A_B·∫†N_V√ÄO_ƒê√ÇY'; 
const SHEET_JSON_URL = 'https://opensheet.elk.sh/1fU4ppbOWDikPkEWUdXiyqrUn8JHXvt-PJjS778J-R8M/Trang%20t%C3%ADnh1';

let currentEmail = null;
let currentIndex = null;

// L·∫Øng nghe link t·ª´ Tampermonkey g·ª≠i v·ªÅ qua localStorage
setInterval(async () => {
    const collectedLink = localStorage.getItem('VS_LAST_COLLECTED_LINK');
    if (collectedLink && currentEmail) {
        const cell = document.getElementById(`invite-res-${currentIndex}`);
        const statusBox = document.getElementById('sync-status');
        
        cell.innerHTML = `<span style="color:orange;">‚è≥ ƒêang ƒë·ªìng b·ªô Sheet...</span>`;
        statusBox.innerText = "üîÑ ƒêang l∆∞u m√£ cho: " + currentEmail;
        statusBox.style.color = "orange";

        try {
            // G·ª≠i d·ªØ li·ªáu sang Google Apps Script
            await fetch(`${WEB_APP_URL}?email=${encodeURIComponent(currentEmail)}&code=${encodeURIComponent(collectedLink)}`, { mode: 'no-cors' });
            
            cell.innerText = collectedLink;
            statusBox.innerText = "‚úÖ ƒê√£ l∆∞u xong: " + currentEmail;
            statusBox.style.color = "green";
        } catch (e) {
            cell.innerText = "‚ùå L·ªói l∆∞u Sheet";
            statusBox.innerText = "‚ùå L·ªói ƒë·ªìng b·ªô!";
            statusBox.style.color = "red";
        }
        
        localStorage.removeItem('VS_LAST_COLLECTED_LINK');
        currentEmail = null;
    }
}, 1000);

async function loadData() {
    try {
        const res = await fetch(SHEET_JSON_URL);
        const data = await res.json();
        const tbody = document.querySelector('#tbody');
        tbody.innerHTML = '';
        data.forEach((row, i) => {
            if(!row.email) return;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${i + 1}</td>
                <td>${row.platform || 'VSPhone'}</td>
                <td><strong>${row.email}</strong></td>
                <td style="font-family:monospace">${row.password}</td>
                <td class="invite-link" id="invite-res-${i}">${row.invite || 'Ch·ªù nh·∫∑t m√£...'}</td>
                <td>
                    <button class="btn btn-login" onclick="login('${row.email}','${row.password}', ${i})">LOGIN</button>
                    <button class="btn btn-buff" onclick="buff(${i})">BUFF</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('sync-status').innerText = "S·∫µn s√†ng: " + data.length + " acc";
    } catch (e) {
        document.getElementById('sync-status').innerText = "‚ùå L·ªói t·∫£i Sheet!";
    }
}

function login(email, pass, index) {
    currentIndex = index;
    currentEmail = email;
    const win = window.open('https://cloud.vsphone.com/login', '_blank');
    
    // G·ª≠i t√≠n hi·ªáu login
    setTimeout(() => {
        win.postMessage({ type: 'AUTO_LOGIN', email, password: pass }, 'https://cloud.vsphone.com');
        // Chuy·ªÉn sang trang invite ƒë·ªÉ nh·∫∑t m√£
        setTimeout(() => { 
            win.location.href = "https://cloud.vsphone.com/share/invite"; 
        }, 3000);
    }, 2000);
}

function buff(index) {
    const invite = document.getElementById(`invite-res-${index}`).innerText;
    if (invite.includes("Ch·ªù")) return alert("Vui l√≤ng l·∫•y m√£ m·ªùi tr∆∞·ªõc!");
    
    const channelId = prompt("Nh·∫≠p ID k√™nh Discord (L∆∞u √Ω: B·∫°n ph·∫£i m·ªü ƒë√∫ng k√™nh n√†y):");
    if (channelId) {
        window.open(`https://discord.com/channels/@me/${channelId}?buff=true`, '_blank');
    }
}

loadData();
</script>
</body>
</html>
