<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <title>VSPhone Dashboard - Cập nhật Cột D</title>
    <style>
        :root { --primary: #5865f2; --success: #3ba55d; --bg: #f3f4f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #edf2f7; text-align: left; }
        th { background: #f8fafc; color: #64748b; font-size: 11px; text-transform: uppercase; }
        .btn { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; font-size: 11px; }
        .btn-login { background: var(--primary); }
        .btn-buff { background: var(--success); }
        .invite-link { font-family: monospace; font-size: 11px; color: #2ecc71; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h2>VSPhone Management</h2>
        <div id="sync-status" style="font-size: 12px; font-weight: bold;">Trạng thái: Đang kết nối...</div>
    </div>

    <table id="accountTable">
        <thead>
            <tr>
                <th>#</th>
                <th>Platform (A)</th>
                <th>Email (B)</th>
                <th>Password (C)</th>
                <th>Mã mời (D)</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

<script>
// DÁN LINK WEB APP CỦA BẠN VÀO ĐÂY
const WEB_APP_URL = 'URL_WEB_APP_CỦA_BẠN'; 
const SHEET_JSON_URL = 'https://opensheet.elk.sh/1fU4ppbOWDikPkEWUdXiyqrUn8JHXvt-PJjS778J-R8M/Trang%20t%C3%ADnh1';

let currentEmail = null;
let currentIndex = null;

setInterval(async () => {
    const collectedLink = localStorage.getItem('VS_LAST_COLLECTED_LINK');
    if (collectedLink && currentEmail) {
        const cell = document.getElementById(`invite-res-${currentIndex}`);
        cell.innerText = "⏳ Đang lưu...";
        try {
            await fetch(`${WEB_APP_URL}?email=${encodeURIComponent(currentEmail)}&code=${encodeURIComponent(collectedLink)}`, { mode: 'no-cors' });
            cell.innerText = collectedLink;
            document.getElementById('sync-status').innerText = "✅ Đã lưu xong cho " + currentEmail;
        } catch (e) {
            cell.innerText = "❌ Lỗi lưu";
        }
        localStorage.removeItem('VS_LAST_COLLECTED_LINK');
        currentEmail = null;
    }
}, 1000);

async function loadData() {
    const res = await fetch(SHEET_JSON_URL);
    const data = await res.json();
    const tbody = document.querySelector('#tbody');
    tbody.innerHTML = '';
    data.forEach((row, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${i + 1}</td>
            <td>${row.platform || ''}</td>
            <td><strong>${row.email}</strong></td>
            <td style="font-family:monospace">${row.password}</td>
            <td class="invite-link" id="invite-res-${i}">${row.invite || 'Chờ nhặt mã...'}</td>
            <td>
                <button class="btn btn-login" onclick="login('${row.email}','${row.password}', ${i})">LOGIN</button>
                <button class="btn btn-buff" onclick="buff(${i})">BUFF</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function login(email, pass, index) {
    currentIndex = index;
    currentEmail = email;
    const win = window.open('https://cloud.vsphone.com/login', '_blank');
    setTimeout(() => {
        win.postMessage({ type: 'AUTO_LOGIN', email, password: pass }, 'https://cloud.vsphone.com');
        setTimeout(() => { win.location.href = "https://cloud.vsphone.com/share/invite"; }, 3000);
    }, 2000);
}

function buff(index) {
    const invite = document.getElementById(`invite-res-${index}`).innerText;
    if (invite.includes("Chờ")) return alert("Vui lòng lấy mã trước");
    const channelId = prompt("Nhập ID kênh Discord:");
    if (channelId) window.open(`https://discord.com/channels/@me/${channelId}?buff=true`, '_blank');
}

loadData();
</script>
</body>
</html>
